# ğŸš€ GitHub Actions Workflows for Infrastructure Management

ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€Terraformãƒ™ãƒ¼ã‚¹ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

## ğŸ“‹ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ¦‚è¦

### ğŸ—ï¸ terraform-test.yml - çµ±åˆCI ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
**è‡ªå‹•å®Ÿè¡Œ**: `infra/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´æ™‚ã«è‡ªå‹•å®Ÿè¡Œ

```yaml
ãƒˆãƒªã‚¬ãƒ¼:
- push (main, develop ãƒ–ãƒ©ãƒ³ãƒ)
- pull_request (main, develop ãƒ–ãƒ©ãƒ³ãƒ)
- infra/** ã®å¤‰æ›´
- workflow_dispatch (æ‰‹å‹•å®Ÿè¡Œ)
```

**åŒ…æ‹¬çš„ãªæ©Ÿèƒ½:**
- ğŸ” å¤‰æ›´æ¤œå‡º (ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°)
- ğŸ§¹ Terraform Lint & Validation + TFLint
- ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ (tfsec, Checkov, SARIF)
- ğŸ§ª Goãƒ†ã‚¹ãƒˆ (Unit/Integration)
- ğŸ“‹ Terraform ãƒ—ãƒ©ãƒ³ç”Ÿæˆãƒ»åˆ†æ
- ğŸ“Š ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†ãƒã‚§ãƒƒã‚¯
- ğŸ’¬ PRè‡ªå‹•ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½

### ğŸš€ terraform-apply.yml - ãƒ‡ãƒ—ãƒ­ã‚¤å°‚ç”¨
**æ‰‹å‹•å®Ÿè¡Œã®ã¿**: `workflow_dispatch`ã«ã‚ˆã‚‹æ‰‹å‹•å®Ÿè¡Œ

```yaml
å¿…é ˆå…¥åŠ›:
- environment: dev/prd
- confirm_apply: "APPLY" ã¨å…¥åŠ›
- dry_run: true (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€ãƒ—ãƒ©ãƒ³ã®ã¿)
```

**å®‰å…¨æ©Ÿèƒ½:**
- âœ… äºŒé‡ç¢ºèªæ©Ÿèƒ½
- ğŸ” äº‹å‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- ğŸ“‹ ãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ—ãƒ©ãƒ³ç”Ÿæˆ
- ğŸ” å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
- ğŸ“Š é©ç”¨å¾Œæ¤œè¨¼

### ğŸ’¥ terraform-destroy.yml - å‰Šé™¤å°‚ç”¨
**æ‰‹å‹•å®Ÿè¡Œã®ã¿**: `workflow_dispatch`ã«ã‚ˆã‚‹æ‰‹å‹•å®Ÿè¡Œ

```yaml
å¿…é ˆå…¥åŠ›:
- environment: dev/prd
- confirm_destroy: "DESTROY" ã¨å…¥åŠ›
- additional_confirmation: ç’°å¢ƒåã‚’å†å…¥åŠ›
- dry_run: true (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€ãƒ—ãƒ©ãƒ³ã®ã¿)
```

**è¶…å®‰å…¨æ©Ÿèƒ½:**
- âš ï¸ ä¸‰é‡ç¢ºèªæ©Ÿèƒ½
- ğŸ” ãƒªã‚½ãƒ¼ã‚¹æ•°ã‚«ã‚¦ãƒ³ãƒˆ
- ğŸš¨ é‡è¦ãƒªã‚½ãƒ¼ã‚¹è­¦å‘Š
- â° å®Ÿè¡Œå‰å¾…æ©Ÿæ™‚é–“
- ğŸ“Š å‰Šé™¤å¾Œæ¤œè¨¼



### ğŸ” dependency-check.yml - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
**å®šæœŸå®Ÿè¡Œ**: æ¯é€±æœˆæ›œæ—¥ + æ‰‹å‹•å®Ÿè¡Œ

```yaml
ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:
- æ¯é€±æœˆæ›œæ—¥ 09:00 (JST)
- workflow_dispatch
```

**ç›£æŸ»æ©Ÿèƒ½:**
- ğŸ”’ Goä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
- ğŸ“Š Terraformãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯
- ğŸ’° ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š
- ğŸ“ˆ SARIFã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆ

## ğŸ”§ å¿…è¦ãªè¨­å®š

### GitHub Secrets
ä»¥ä¸‹ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š

```yaml
AWS_ACCESS_KEY_ID: AWS ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼
AWS_SECRET_ACCESS_KEY: AWS ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼
INFRACOST_API_KEY: Infracost API ã‚­ãƒ¼ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
```

### GitHub Environments
æœ¬ç•ªç’°å¢ƒã®ä¿è­·ã®ãŸã‚ã€ä»¥ä¸‹ã®ç’°å¢ƒã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ï¼š

```yaml
environments:
- dev: é–‹ç™ºç’°å¢ƒ (åˆ¶é™ãªã—)
- prd: æœ¬ç•ªç’°å¢ƒ (æ‰¿èªå¿…é ˆ)
- dev-destroy: é–‹ç™ºå‰Šé™¤ (åˆ¶é™ãªã—)
- prd-destroy: æœ¬ç•ªå‰Šé™¤ (è¤‡æ•°æ‰¿èªå¿…é ˆ)
```

## ğŸ“Š ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œé †åº

### ğŸ”„ é€šå¸¸ã®é–‹ç™ºãƒ•ãƒ­ãƒ¼

1. **é–‹ç™ºä½œæ¥­**
   ```bash
   # infra/ é…ä¸‹ã§Terraformå¤‰æ›´
   git add infra/
   git commit -m "feat: update infrastructure"
   git push origin feature/update-infra
   ```

2. **PRä½œæˆæ™‚**
   - `terraform-test.yml` (çµ±åˆCI) ãŒè‡ªå‹•å®Ÿè¡Œ
   - PRã«çµæœã‚³ãƒ¡ãƒ³ãƒˆãŒè‡ªå‹•æŠ•ç¨¿ã•ã‚Œã‚‹

3. **PRæ‰¿èªãƒ»ãƒãƒ¼ã‚¸å¾Œ**
   - `terraform-test.yml` (çµ±åˆCI) ãŒå†åº¦å®Ÿè¡Œ
   - ãƒ—ãƒ©ãƒ³ãŒç”Ÿæˆãƒ»ä¿å­˜ã•ã‚Œã‚‹

4. **æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤**
   ```yaml
   # GitHub UI ã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œ
   terraform-apply.yml:
     environment: prd
     confirm_apply: "APPLY"
     dry_run: false
   ```

### ğŸš¨ ç·Šæ€¥å‰Šé™¤ãƒ•ãƒ­ãƒ¼

1. **å‰Šé™¤ãƒ—ãƒ©ãƒ³ç¢ºèª**
   ```yaml
   terraform-destroy.yml:
     environment: dev
     confirm_destroy: "DESTROY"
     additional_confirmation: "dev"
     dry_run: true  # ãƒ—ãƒ©ãƒ³ã®ã¿
   ```

2. **å®Ÿéš›ã®å‰Šé™¤å®Ÿè¡Œ**
   ```yaml
   terraform-destroy.yml:
     environment: dev
     confirm_destroy: "DESTROY"
     additional_confirmation: "dev"
     dry_run: false  # å®Ÿéš›ã«å‰Šé™¤
   ```

## ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½

### CIæ®µéšã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- **tfsec**: ãƒªã‚½ãƒ¼ã‚¹è¨­å®šã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
- **Checkov**: è¨­å®šãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ãƒã‚§ãƒƒã‚¯
- **TFLint**: Terraformæ§‹æ–‡ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
- **Gosec**: Goã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³

### Deployæ®µéšã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- **äºŒé‡ç¢ºèª**: Applyæ™‚ã«"APPLY"å…¥åŠ›å¿…é ˆ
- **ç’°å¢ƒä¿è­·**: GitHubEnvironmentsé€£æº
- **ãƒ—ãƒ©ãƒ³æ¤œè¨¼**: å±é™ºãªæ“ä½œã®äº‹å‰æ¤œå‡º
- **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—**: å®Ÿè¡Œå±¥æ­´ã®è¨˜éŒ²

### Destroyæ®µéšã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- **ä¸‰é‡ç¢ºèª**: "DESTROY" + ç’°å¢ƒåå…¥åŠ›å¿…é ˆ
- **é‡è¦ãƒªã‚½ãƒ¼ã‚¹è­¦å‘Š**: DBã€S3ç­‰ã®è­¦å‘Šè¡¨ç¤º
- **å®Ÿè¡Œå‰å¾…æ©Ÿ**: 10ç§’é–“ã®æœ€çµ‚ç¢ºèªæ™‚é–“
- **æ®µéšçš„å®Ÿè¡Œ**: Plan â†’ Apply ã®æ˜ç¢ºãªåˆ†é›¢

## ğŸ“ˆ ç›£è¦–ã¨ãƒ¬ãƒãƒ¼ãƒˆ

### å®Ÿè¡Œçµæœã®ç¢ºèªæ–¹æ³•

1. **GitHub Actions ã‚¿ãƒ–**
   - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œå±¥æ­´
   - ã‚¸ãƒ§ãƒ–åˆ¥å®Ÿè¡ŒçŠ¶æ³
   - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¨ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹

2. **PR ã‚³ãƒ¡ãƒ³ãƒˆ**
   - ãƒ†ã‚¹ãƒˆçµæœã®è‡ªå‹•æŠ•ç¨¿
   - ãƒ—ãƒ©ãƒ³å·®åˆ†ã®è¡¨ç¤º
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ

3. **Step Summary**
   - å®Ÿè¡Œã‚µãƒãƒªãƒ¼ã®è¡¨ç¤º
   - ãƒªã‚½ãƒ¼ã‚¹æ•°ã®è¨˜éŒ²
   - æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ææ¡ˆ

### ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆç®¡ç†

```yaml
ä¿å­˜æœŸé–“:
- terraform-plan-*: 5æ—¥é–“
- terraform-apply-plan-*: 1æ—¥é–“
- terraform-destroy-plan-*: 1æ—¥é–“
- security-reports: 30æ—¥é–“
```

## ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ä¸¦åˆ—å®Ÿè¡Œæˆ¦ç•¥
- **Matrix Strategy**: è¤‡æ•°ç’°å¢ƒã®åŒæ™‚å‡¦ç†
- **Job Dependencies**: å¿…è¦æœ€å°é™ã®ä¾å­˜é–¢ä¿‚
- **Artifact Cache**: TerraformåˆæœŸåŒ–ã®é«˜é€ŸåŒ–

### ã‚³ã‚¹ãƒˆæœ€é©åŒ–
- **Change Detection**: å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿å®Ÿè¡Œ
- **Conditional Jobs**: æ¡ä»¶ä»˜ãã‚¸ãƒ§ãƒ–å®Ÿè¡Œ
- **Resource Cleanup**: ä¸è¦ãªã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®è‡ªå‹•å‰Šé™¤

## ğŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ³•

1. **èªè¨¼ã‚¨ãƒ©ãƒ¼**
   ```yaml
   åŸå› : AWSèªè¨¼æƒ…å ±ã®æœŸé™åˆ‡ã‚Œ
   è§£æ±º: GitHub Secretsã‚’æ›´æ–°
   ```

2. **ã‚¹ãƒ†ãƒ¼ãƒˆãƒ­ãƒƒã‚¯**
   ```yaml
   åŸå› : ä¸¦è¡Œå®Ÿè¡Œã«ã‚ˆã‚‹ãƒ­ãƒƒã‚¯ç«¶åˆ
   è§£æ±º: æ‰‹å‹•ã§ã®ãƒ­ãƒƒã‚¯è§£é™¤ãŒå¿…è¦
   ```

3. **ãƒ—ãƒ©ãƒ³å·®åˆ†ãªã—**
   ```yaml
   åŸå› : å®Ÿéš›ã®å¤‰æ›´ãŒãªã„
   ç¢ºèª: terraform plan ã®è©³ç´°ã‚’ç¢ºèª
   ```

### ç·Šæ€¥æ™‚ã®å¯¾å¿œ

1. **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åœæ­¢**
   ```bash
   GitHub UI -> Actions -> å®Ÿè¡Œä¸­ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ -> Cancel
   ```

2. **å¼·åˆ¶å®Ÿè¡Œ**
   ```bash
   # ãƒ­ãƒ¼ã‚«ãƒ«ã§ç›´æ¥å®Ÿè¡Œ
   cd infra/aws/env/dev
   terraform init
   terraform plan
   terraform apply
   ```

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [Terraform GitHub Actions](https://github.com/hashicorp/setup-terraform)
- [AWS Provider Documentation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [Terratest Documentation](https://terratest.gruntwork.io/)
- [GitHub Actions Security](https://docs.github.com/en/actions/security-guides)

## ğŸ¯ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### é–‹ç™ºæ™‚
- âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚’ç¿’æ…£åŒ–
- âœ… å°ã•ãªå¤‰æ›´å˜ä½ã§ã®ã‚³ãƒŸãƒƒãƒˆ
- âœ… é©åˆ‡ãªã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¨˜è¿°

### ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚
- âœ… ãƒ—ãƒ©ãƒ³çµæœã®è©³ç´°ç¢ºèª
- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœã®ãƒã‚§ãƒƒã‚¯
- âœ… ãƒ†ã‚¹ãƒˆçµæœã®æ¤œè¨¼

### ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚
- âœ… äº‹å‰ã®ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³å®Ÿè¡Œ
- âœ… æœ¬ç•ªç’°å¢ƒã§ã®æ®µéšçš„é©ç”¨
- âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®å‹•ä½œç¢ºèª 
