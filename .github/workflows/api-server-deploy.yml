name: ğŸš€ API Server Deploy to ECS
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prd
      image_tag:
        description: 'Docker image tag (optional - uses latest if not specified)'
        required: false
        type: string
      confirm_deploy:
        description: 'Type "DEPLOY" exactly to confirm deployment (case sensitive)'
        required: true
        type: string
  workflow_run:
    workflows: ["ğŸ³ API Server Image Push"]
    types: [completed]
    branches: [main, develop]
permissions:
  contents: read
  id-token: write
defaults:
  run:
    shell: bash
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: english-card-battle-server

jobs:
  # ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æ¤œè¨¼
  pre-deploy-checks:
    name: ğŸ” Pre-Deploy Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'workflow_dispatch'
    outputs:
      should_deploy: ${{ steps.validation.outputs.should_deploy }}
      environment: ${{ steps.validation.outputs.environment }}
      image_tag: ${{ steps.validation.outputs.image_tag }}
    
    steps:
      - name: ğŸ” å…¥åŠ›å€¤ã‚’æ¤œè¨¼
        id: validation
        run: |
          if [[ "${{ github.event.inputs.confirm_deploy }}" != "DEPLOY" ]]; then
            echo "âŒ You must type 'DEPLOY' exactly to confirm deployment"
            exit 1
          fi
          
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          
          if [[ -z "$IMAGE_TAG" ]]; then
            IMAGE_TAG="${ENVIRONMENT}-latest"
          fi
          
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          
          echo "âœ… Validation passed"
          echo "ğŸ“ Environment: ${ENVIRONMENT}"
          echo "ğŸ·ï¸ Image Tag: ${IMAGE_TAG}"

  # è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆImage Pushãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†å¾Œï¼‰
  auto-deploy:
    name: ğŸ¤– Auto Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
    outputs:
      should_deploy: ${{ steps.setup.outputs.should_deploy }}
      environment: ${{ steps.setup.outputs.environment }}
      image_tag: ${{ steps.setup.outputs.image_tag }}
    
    steps:
      - name: âš™ï¸ è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã®è¨­å®š
        id: setup
        run: |
          ENVIRONMENT=${{ github.event.workflow_run.head_branch == 'main' && 'prd' || 'dev' }}
          IMAGE_TAG="${ENVIRONMENT}-latest"
          
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          
          echo "ğŸ¤– Auto deploy triggered"
          echo "ğŸ“ Environment: ${ENVIRONMENT}"
          echo "ğŸ·ï¸ Image Tag: ${IMAGE_TAG}"

  # ECSãƒ‡ãƒ—ãƒ­ã‚¤
  deploy:
    name: ğŸš€ Deploy to ECS Fargate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [pre-deploy-checks, auto-deploy]
    if: always() && (needs.pre-deploy-checks.outputs.should_deploy == 'true' || needs.auto-deploy.outputs.should_deploy == 'true')
    environment: 
      name: ${{ needs.pre-deploy-checks.outputs.environment || needs.auto-deploy.outputs.environment }}
      url: https://console.aws.amazon.com/ecs
    
    env:
      ENVIRONMENT: ${{ needs.pre-deploy-checks.outputs.environment || needs.auto-deploy.outputs.environment }}
      IMAGE_TAG: ${{ needs.pre-deploy-checks.outputs.image_tag || needs.auto-deploy.outputs.image_tag }}
    
    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ”‘ AWSèªè¨¼ã‚’è¨­å®š
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” ECRã«ãƒ­ã‚°ã‚¤ãƒ³
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ·ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±ã‚’è¨­å®š
        id: deploy-info
        run: |
          CLUSTER_NAME="english-card-battle-${ENVIRONMENT}"
          SERVICE_NAME="english-card-battle-server-${ENVIRONMENT}"
          TASK_DEFINITION_FAMILY="english-card-battle-server-${ENVIRONMENT}"
          
          echo "cluster_name=${CLUSTER_NAME}" >> $GITHUB_OUTPUT
          echo "service_name=${SERVICE_NAME}" >> $GITHUB_OUTPUT
          echo "task_definition_family=${TASK_DEFINITION_FAMILY}" >> $GITHUB_OUTPUT
          echo "image_uri=${{ steps.login-ecr.outputs.registry }}/${ECR_REPOSITORY}:${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: ğŸ“‹ ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’å–å¾—
        id: current-task-def
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ steps.deploy-info.outputs.task_definition_family }} \
            --query 'taskDefinition' \
            --output json > current-task-definition.json
          
          # æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸URIã§æ›´æ–°
          jq --arg IMAGE_URI "${{ steps.deploy-info.outputs.image_uri }}" \
            '.containerDefinitions[0].image = $IMAGE_URI' \
            current-task-definition.json > new-task-definition.json
          
          # ECSç”¨ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤ï¼‰
          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .placementConstraints, .compatibilities, .registeredAt, .registeredBy)' \
            new-task-definition.json > clean-task-definition.json

      - name: ğŸ†• æ–°ã—ã„ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ç™»éŒ²
        id: new-task-def
        run: |
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://clean-task-definition.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          
          echo "task_definition_arn=${NEW_TASK_DEF_ARN}" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ New task definition registered: ${NEW_TASK_DEF_ARN}"

      - name: ğŸ”„ ECSã‚µãƒ¼ãƒ“ã‚¹ã‚’æ›´æ–°
        run: |
          echo "ğŸš€ Updating ECS service..."
          aws ecs update-service \
            --cluster ${{ steps.deploy-info.outputs.cluster_name }} \
            --service ${{ steps.deploy-info.outputs.service_name }} \
            --task-definition ${{ steps.new-task-def.outputs.task_definition_arn }} \
            --force-new-deployment

      - name: â³ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’å¾…æ©Ÿ
        timeout-minutes: 15
        run: |
          echo "â³ Waiting for deployment to complete..."
          aws ecs wait services-stable \
            --cluster ${{ steps.deploy-info.outputs.cluster_name }} \
            --services ${{ steps.deploy-info.outputs.service_name }}
          
          echo "âœ… Deployment completed successfully!"

      - name: ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç¢ºèª
        run: |
          echo "ğŸ” Checking deployment status..."
          
          # ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª
          SERVICE_STATUS=$(aws ecs describe-services \
            --cluster ${{ steps.deploy-info.outputs.cluster_name }} \
            --services ${{ steps.deploy-info.outputs.service_name }} \
            --query 'services[0].status' \
            --output text)
          
          # ã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹ã‚’ç¢ºèª
          RUNNING_TASKS=$(aws ecs describe-services \
            --cluster ${{ steps.deploy-info.outputs.cluster_name }} \
            --services ${{ steps.deploy-info.outputs.service_name }} \
            --query 'services[0].runningCount' \
            --output text)
          
          echo "ğŸ“Š Service Status: ${SERVICE_STATUS}"
          echo "ğŸƒ Running Tasks: ${RUNNING_TASKS}"
          
          if [[ "${SERVICE_STATUS}" == "ACTIVE" && "${RUNNING_TASKS}" -gt 0 ]]; then
            echo "âœ… Deployment verification successful!"
          else
            echo "âŒ Deployment verification failed!"
            exit 1
          fi

      - name: ğŸ“ ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚’ã‚µãƒãƒªãƒ¼ã«å‡ºåŠ›
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## ğŸš€ API Server ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
          
          ### ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±
          - **ç’°å¢ƒ**: ${{ env.ENVIRONMENT }}
          - **ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼**: ${{ steps.deploy-info.outputs.cluster_name }}
          - **ã‚µãƒ¼ãƒ“ã‚¹**: ${{ steps.deploy-info.outputs.service_name }}
          - **ã‚¤ãƒ¡ãƒ¼ã‚¸**: ${{ steps.deploy-info.outputs.image_uri }}
          - **ã‚¿ã‚¹ã‚¯å®šç¾©**: ${{ steps.new-task-def.outputs.task_definition_arn }}
          
          ### âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
          ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼
          
          [ECS Console ã§ç¢ºèª](https://console.aws.amazon.com/ecs/home?region=${{ env.AWS_REGION }}#/clusters/${{ steps.deploy-info.outputs.cluster_name }}/services/${{ steps.deploy-info.outputs.service_name }}/details)
          EOF 
