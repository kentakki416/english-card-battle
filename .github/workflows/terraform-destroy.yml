name: 💥 Terraform Destroy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prd
      confirm_destroy:
        description: 'Type "DESTROY" exactly to confirm destruction (case sensitive)'
        required: true
        type: string
      dry_run:
        description: 'Run destroy plan only (dry run)'
        required: false
        default: true
        type: boolean

env:
  TF_VERSION: "1.7.0"
  TF_IN_AUTOMATION: true
  TF_INPUT: false
  AWS_REGION: ap-northeast-1

jobs:
  terraform-destroy:
    name: 💥 Terraform Destroy
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment }}-destroy
      url: https://console.aws.amazon.com/
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      TF_VAR_environment: ${{ github.event.inputs.environment }}
    steps:
      - name: 🔍 Validate Inputs
        run: |
          echo "🔍 Validating destroy inputs..."
          
          # Normalize inputs
          CONFIRM_DESTROY=$(echo "${{ github.event.inputs.confirm_destroy }}" | tr -d '[:space:]')
          ENVIRONMENT=$(echo "${{ github.event.inputs.environment }}" | tr -d '[:space:]')
          
          # Check confirmation
          if [[ "${CONFIRM_DESTROY}" != "DESTROY" ]]; then
            echo "❌ You must type 'DESTROY' exactly to confirm"
            exit 1
          fi
          
          # Check environment validity  
          if [[ "${ENVIRONMENT}" != "dev" && "${ENVIRONMENT}" != "prd" ]]; then
            echo "❌ Invalid environment: ${ENVIRONMENT}"
            exit 1
          fi
          
          # Production warning
          if [[ "${ENVIRONMENT}" == "prd" ]]; then
            echo "⚠️ PRODUCTION ENVIRONMENT DESTROY!"
            echo "🚨 This will permanently delete all production resources!"
            sleep 5
          fi
          
          echo "✅ Input validation passed"

      - name: 📥 Checkout & Setup
        uses: actions/checkout@v4

      - name: ⚙️ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: 🔍 Check Current State
        id: state-check
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "🔍 Checking Terraform state..."
          terraform init
          
          RESOURCE_COUNT=$(terraform state list 2>/dev/null | wc -l || echo "0")
          echo "RESOURCE_COUNT=$RESOURCE_COUNT" >> $GITHUB_ENV
          
          if [[ "$RESOURCE_COUNT" -eq 0 ]]; then
            echo "ℹ️ No resources found. Nothing to destroy."
          else
            echo "⚠️ Found $RESOURCE_COUNT resources to destroy:"
            terraform state list
          fi

      - name: 📋 Generate Destroy Plan
        if: env.RESOURCE_COUNT != '0'
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "📋 Creating destroy plan..."
          terraform plan -destroy -detailed-exitcode -out=destroy.tfplan
          
      - name: 🔍 Terraform show
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "📋 Showing destroy plan..."
          terraform show destroy.tfplan

      - name: 🔍 Critical Resource Check
        if: env.RESOURCE_COUNT != '0'
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "🔍 Checking for critical resources..."
          
          CRITICAL_WARNINGS=0
          
          # 重要なリソースの削除をチェック
          # ケース例: データベース(RDS)、ストレージ(S3)、ロードバランサーなど
          # これらの削除は通常、データ損失やサービス停止を伴うため要注意
          PLAN_OUTPUT=$(terraform show destroy.tfplan 2>/dev/null || echo "")
          if echo "$PLAN_OUTPUT" | grep -i "rds\|database\|s3_bucket\|lb\|load_balancer" >/dev/null 2>&1; then
            echo "⚠️ 警告: 以下の重要なリソースが削除されます"
            echo "$PLAN_OUTPUT" | grep -i "rds\|database\|s3_bucket\|lb\|load_balancer" || true
            echo "CRITICAL_DETECTED=true" >> $GITHUB_ENV
            CRITICAL_WARNINGS=1
          fi
          
          # Destroyは破壊的操作なので警告表示（ユーザーは既に"DESTROY"で確認済み）
          if [[ $CRITICAL_WARNINGS -gt 0 ]]; then
            echo ""
            echo "⚠️ 重要リソースの削除が検出されました"
            echo "🛑 意図的な削除であることを再確認してください"
            echo "CRITICAL_WARNINGS_COUNT=$CRITICAL_WARNINGS" >> $GITHUB_ENV
            sleep 10  # 10秒間の確認時間
          else
            echo "✅ 重要リソースの削除は検出されませんでした"
          fi

      - name: 💥 Execute Destroy
        if: env.RESOURCE_COUNT != '0' && github.event.inputs.dry_run != 'true'
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "💥 Executing destroy for ${{ github.event.inputs.environment }}..."
          echo "⚠️ FINAL WARNING: Starting in 10 seconds..."
          sleep 10
          
          echo "⏰ Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          terraform apply destroy.tfplan
          echo "✅ Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: 🔍 Verify Results
        if: env.RESOURCE_COUNT != '0' && github.event.inputs.dry_run != 'true'
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "🔍 Verifying destroy results..."
          REMAINING=$(terraform state list | wc -l)
          
          if [[ "$REMAINING" -eq 0 ]]; then
            echo "✅ All resources destroyed successfully"
            echo "DESTROY_STATUS=success" >> $GITHUB_ENV
          else
            echo "⚠️ $REMAINING resources remain"
            terraform state list
            echo "DESTROY_STATUS=partial" >> $GITHUB_ENV
          fi

      - name: 📊 Summary
        run: |
          echo "## 💥 Terraform Destroy Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # 重要リソースの警告がある場合は最初に表示
          if [[ "${{ env.CRITICAL_WARNINGS_COUNT }}" != "" && "${{ env.CRITICAL_WARNINGS_COUNT }}" != "0" ]]; then
            echo "### ⚠️ 重要リソース削除警告" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**重要なインフラストラクチャコンポーネントが削除されます:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "🚨 **以下のリソースが永続的に削除されます:**" >> $GITHUB_STEP_SUMMARY
            echo "- 📊 データベース (RDS instances)" >> $GITHUB_STEP_SUMMARY
            echo "- 💾 ストレージバケット (S3)" >> $GITHUB_STEP_SUMMARY
            echo "- ⚖️ ロードバランサー" >> $GITHUB_STEP_SUMMARY
            echo "- 🏗️ その他の重要インフラストラクチャ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ **データ損失やサービス停止の可能性があります**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| 🌍 Environment | \`${{ github.event.inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 🔄 Mode | \`${{ github.event.inputs.dry_run == 'true' && 'Dry Run' || 'Execute' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 📊 Resources | \`${{ env.RESOURCE_COUNT }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ⚠️ Critical Warnings | \`${{ env.CRITICAL_WARNINGS_COUNT || '0' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 👤 By | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 🕐 Time | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ env.RESOURCE_COUNT }}" == "0" ]]; then
            echo "### ℹ️ No resources found to destroy" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "### 📋 Dry run completed - plan generated" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ env.CRITICAL_WARNINGS_COUNT }}" != "" && "${{ env.CRITICAL_WARNINGS_COUNT }}" != "0" ]]; then
              echo "⚠️ **重要リソースの削除を確認してから実行してください** - dry_run=falseで再実行" >> $GITHUB_STEP_SUMMARY
            else
              echo "✅ 重要リソースの削除なし - dry_run=falseで実行可能です" >> $GITHUB_STEP_SUMMARY
            fi
          elif [[ "${{ env.DESTROY_STATUS }}" == "success" ]]; then
            echo "### ✅ Destroy completed successfully" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ env.DESTROY_STATUS }}" == "partial" ]]; then
            echo "### ⚠️ Partial destroy - some resources remain" >> $GITHUB_STEP_SUMMARY
          fi 
