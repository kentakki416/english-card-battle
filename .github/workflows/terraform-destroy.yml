name: ðŸ’¥ Terraform Destroy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prd
      confirm_destroy:
        description: 'Type "DESTROY" exactly to confirm destruction (case sensitive)'
        required: true
        type: string
      dry_run:
        description: 'Run destroy plan only (dry run)'
        required: false
        default: true
        type: boolean

env:
  TF_VERSION: "1.7.0"
  TF_IN_AUTOMATION: true
  TF_INPUT: false
  AWS_REGION: ap-northeast-1

jobs:
  terraform-destroy:
    name: ðŸ’¥ Terraform Destroy
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment }}-destroy
      url: https://console.aws.amazon.com/
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      TF_VAR_environment: ${{ github.event.inputs.environment }}
    steps:
      - name: ðŸ” Validate Inputs
        run: |
          echo "ðŸ” Validating destroy inputs..."
          
          # Normalize inputs
          CONFIRM_DESTROY=$(echo "${{ github.event.inputs.confirm_destroy }}" | tr -d '[:space:]')
          ENVIRONMENT=$(echo "${{ github.event.inputs.environment }}" | tr -d '[:space:]')
          
          # Check confirmation
          if [[ "${CONFIRM_DESTROY}" != "DESTROY" ]]; then
            echo "âŒ You must type 'DESTROY' exactly to confirm"
            exit 1
          fi
          
          # Check environment validity  
          if [[ "${ENVIRONMENT}" != "dev" && "${ENVIRONMENT}" != "prd" ]]; then
            echo "âŒ Invalid environment: ${ENVIRONMENT}"
            exit 1
          fi
          
          # Production warning
          if [[ "${ENVIRONMENT}" == "prd" ]]; then
            echo "âš ï¸ PRODUCTION ENVIRONMENT DESTROY!"
            echo "ðŸš¨ This will permanently delete all production resources!"
            sleep 5
          fi
          
          echo "âœ… Input validation passed"

      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ðŸ”§ Terraform init
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸš€ Initializing Terraform for ${{ github.event.inputs.environment }}..."
          terraform init

      - name: ðŸ” Check Current State
        id: state-check
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ” Checking Terraform state..."
          
          RESOURCE_COUNT=$(terraform state list 2>/dev/null | wc -l || echo "0")
          echo "RESOURCE_COUNT=$RESOURCE_COUNT" >> $GITHUB_ENV
          
          if [[ "$RESOURCE_COUNT" -eq 0 ]]; then
            echo "â„¹ï¸ No resources found. Nothing to destroy."
          else
            echo "âš ï¸ Found $RESOURCE_COUNT resources to destroy:"
            terraform state list
          fi

      - name: ðŸ“‹ Generate Destroy Plan
        if: env.RESOURCE_COUNT != '0'
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ“‹ Creating destroy plan..."
          terraform plan -destroy -detailed-exitcode -out=destroy.tfplan
          
      - name: ðŸ” Terraform show
        if: env.RESOURCE_COUNT != '0'
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          terraform show destroy.tfplan

      - name: ðŸ” Critical Resource Check
        if: env.RESOURCE_COUNT != '0'
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ” Checking for critical resources..."
          
          CRITICAL_WARNINGS=0
          
          # é‡è¦ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤ãƒã‚§ãƒƒã‚¯
          # ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®å…¨å‰Šé™¤ã¯é‡å¤§ãªå½±éŸ¿ã‚’ä¼´ã†å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚è­¦å‘Šè¡¨ç¤º
          if [[ "${{ env.RESOURCE_COUNT }}" != "0" ]]; then
            echo "âš ï¸ è­¦å‘Š: ${{ env.RESOURCE_COUNT }}å€‹ã®ãƒªã‚½ãƒ¼ã‚¹ãŒå‰Šé™¤ã•ã‚Œã¾ã™"
            echo "ðŸ’¡ å‰Šé™¤äºˆå®šã®è©³ç´°ã¯Terraformãƒ—ãƒ©ãƒ³å‡ºåŠ›ã§ç¢ºèªã—ã¦ãã ã•ã„"
            echo "CRITICAL_DETECTED=true" >> $GITHUB_ENV
            CRITICAL_WARNINGS=1
          fi
          
          # Destroyã¯ç ´å£Šçš„æ“ä½œãªã®ã§è­¦å‘Šè¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ—¢ã«"DESTROY"ã§ç¢ºèªæ¸ˆã¿ï¼‰
          if [[ $CRITICAL_WARNINGS -gt 0 ]]; then
            echo ""
            echo "âš ï¸ é‡è¦ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "ðŸ›‘ æ„å›³çš„ãªå‰Šé™¤ã§ã‚ã‚‹ã“ã¨ã‚’å†ç¢ºèªã—ã¦ãã ã•ã„"
            echo "CRITICAL_WARNINGS_COUNT=$CRITICAL_WARNINGS" >> $GITHUB_ENV
            sleep 10  # 10ç§’é–“ã®ç¢ºèªæ™‚é–“
          else
            echo "âœ… é‡è¦ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: ðŸ’¥ Execute Destroy
        if: env.RESOURCE_COUNT != '0' && github.event.inputs.dry_run != 'true'
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ’¥ Executing destroy for ${{ github.event.inputs.environment }}..."
          echo "âš ï¸ FINAL WARNING: Starting in 10 seconds..."
          sleep 10
          
          echo "â° Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          terraform apply destroy.tfplan
          echo "âœ… Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: ðŸ” Verify Results
        if: env.RESOURCE_COUNT != '0' && github.event.inputs.dry_run != 'true'
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ” Verifying destroy results..."
          REMAINING=$(terraform state list | wc -l)
          
          if [[ "$REMAINING" -eq 0 ]]; then
            echo "âœ… All resources destroyed successfully"
            echo "DESTROY_STATUS=success" >> $GITHUB_ENV
          else
            echo "âš ï¸ $REMAINING resources remain"
            terraform state list
            echo "DESTROY_STATUS=partial" >> $GITHUB_ENV
          fi

      - name: ðŸ“Š Plan Analysis
        if: env.RESOURCE_COUNT != '0'
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ“Š Analyzing destroy plan..."
          
          # terraform showã®å‡ºåŠ›ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦å‰Šé™¤å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹ã‚’æŠ½å‡º
          PLAN_OUTPUT=$(terraform show destroy.tfplan 2>/dev/null || echo "")
          
          # å‰Šé™¤ã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹åã‚’æŠ½å‡º
          RESOURCES_TO_DESTROY=$(echo "$PLAN_OUTPUT" | grep "^  # .* will be destroyed$" | sed 's/^  # \(.*\) will be destroyed$/\1/' || true)
          DESTROY_COUNT=$(echo "$RESOURCES_TO_DESTROY" | grep -c . || echo "0")
          
          echo "DESTROY_COUNT=$DESTROY_COUNT" >> $GITHUB_ENV
          
          # å…¨ãƒªã‚½ãƒ¼ã‚¹ã‚’ä¿å­˜ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ†ã‘ãªã—ã€å®Œå…¨å‹•çš„ï¼‰
          echo "$RESOURCES_TO_DESTROY" > /tmp/all_resources.txt
          
          # ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã‚’è‡ªå‹•æŠ½å‡ºã—ã¦ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå®Œå…¨å‹•çš„ï¼‰
          if [[ -n "$RESOURCES_TO_DESTROY" ]]; then
            echo "$RESOURCES_TO_DESTROY" | sed 's/\[.*\]//' | cut -d'.' -f1 | sort | uniq -c | sort -nr > /tmp/resource_types.txt
            
            echo "ðŸ“Š Resource types to be destroyed:"
            cat /tmp/resource_types.txt | while read count type; do
              echo "  - $type: $count resources"
            done
          fi
          
          echo "ðŸ“Š Destroy plan analysis completed: $DESTROY_COUNT total resources"

      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸ’¥ Terraform Destroy Plan (${{ github.event.inputs.environment }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ env.RESOURCE_COUNT }}" == "0" ]]; then
            echo "### â„¹ï¸ No Resources to Destroy" >> $GITHUB_STEP_SUMMARY
            echo "ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ãƒˆã«ã¯ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ—‘ï¸ Destroy Summary" >> $GITHUB_STEP_SUMMARY
            echo "**${{ env.DESTROY_COUNT }}å€‹ã®ãƒªã‚½ãƒ¼ã‚¹ãŒå‰Šé™¤ã•ã‚Œã¾ã™**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—åˆ¥ã®çµ±è¨ˆã‚’å‹•çš„è¡¨ç¤º
            if [[ -s /tmp/resource_types.txt ]]; then
              echo "#### ðŸ“Š Resource Types" >> $GITHUB_STEP_SUMMARY
              echo "| Resource Type | Count |" >> $GITHUB_STEP_SUMMARY
              echo "|---------------|-------|" >> $GITHUB_STEP_SUMMARY
              cat /tmp/resource_types.txt | while read count type; do
                echo "| \`$type\` | $count |" >> $GITHUB_STEP_SUMMARY
              done
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # å‰Šé™¤å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§ï¼ˆæœ€å¤§10ä»¶ã¾ã§è¡¨ç¤ºï¼‰
            echo "#### ðŸ—‘ï¸ Resources to be Destroyed" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            if [[ -s /tmp/all_resources.txt ]]; then
              head -10 /tmp/all_resources.txt >> $GITHUB_STEP_SUMMARY
              TOTAL_RESOURCES=$(cat /tmp/all_resources.txt | wc -l)
              if [[ $TOTAL_RESOURCES -gt 10 ]]; then
                echo "... and $((TOTAL_RESOURCES - 10)) more resources" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "No resources found" >> $GITHUB_STEP_SUMMARY
            fi
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # å®Ÿè¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "### ðŸ“‹ Dry Run Completed" >> $GITHUB_STEP_SUMMARY
            echo "âœ… å‰Šé™¤ãƒ—ãƒ©ãƒ³ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å®Ÿè¡Œã™ã‚‹ã«ã¯ \`dry_run=false\` ã§å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ env.DESTROY_STATUS }}" == "success" ]]; then
            echo "### âœ… Destroy Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¥ ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ãŒæ­£å¸¸ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ env.DESTROY_STATUS }}" == "partial" ]]; then
            echo "### âš ï¸ Partial Destroy" >> $GITHUB_STEP_SUMMARY
            echo "ä¸€éƒ¨ã®ãƒªã‚½ãƒ¼ã‚¹ãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚æ‰‹å‹•ã§ã®ç¢ºèªãŒå¿…è¦ã§ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          fi 
