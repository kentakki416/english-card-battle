name: ðŸ” Dependency Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run dependency check every Monday at 9 AM JST (00:00 UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  go-security:
    name: ðŸ”’ Go Security Scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-dir: [unit, integration]
      fail-fast: false
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: ðŸ“‹ Check Go Module
        id: check-go-module
        working-directory: infra/aws/test/${{ matrix.test-dir }}
        run: |
          echo "ðŸ” Checking Go module in ${{ matrix.test-dir }} directory..."
          if [ ! -f "go.mod" ]; then
            echo "âŒ go.mod file not found in ${{ matrix.test-dir }}"
            exit 1
          fi
          echo "âœ… go.mod file found"
          
          # Check if there are any Go files
          if [ -z "$(find . -name '*.go' -type f)" ]; then
            echo "âš ï¸ No Go files found in ${{ matrix.test-dir }}"
            echo "skip-security-scan=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Go files found"
            echo "skip-security-scan=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¦ Download Go Dependencies
        working-directory: infra/aws/test/${{ matrix.test-dir }}
        run: |
          echo "ðŸ” Processing Go module in ${{ matrix.test-dir }} directory..."
          go mod download
          go mod tidy

      - name: ðŸ” Install Gosec
        if: steps.check-go-module.outputs.skip-security-scan != 'true'
        run: |
          echo "ðŸ”’ Installing Gosec security scanner..."
          curl -sfL https://raw.githubusercontent.com/securecodewarrior/gosec/master/install.sh | sh -s -- -b $(go env GOPATH)/bin latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: ðŸ” Run Gosec Security Scanner
        if: steps.check-go-module.outputs.skip-security-scan != 'true'
        working-directory: infra/aws/test/${{ matrix.test-dir }}
        run: |
          echo "ðŸ”’ Running Gosec security scan for ${{ matrix.test-dir }}..."
          gosec -fmt sarif -out gosec-${{ matrix.test-dir }}-results.sarif ./...
        continue-on-error: true

      - name: ðŸ“Š Upload Gosec Results
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('infra/aws/test/${{ matrix.test-dir }}/gosec-${{ matrix.test-dir }}-results.sarif') != ''
        with:
          sarif_file: infra/aws/test/${{ matrix.test-dir }}/gosec-${{ matrix.test-dir }}-results.sarif

      - name: ðŸ›¡ï¸ Install Nancy
        if: steps.check-go-module.outputs.skip-security-scan != 'true'
        run: |
          echo "ðŸ›¡ï¸ Installing Nancy vulnerability scanner..."
          go install github.com/sonatypecommunity/nancy@latest

      - name: ðŸ›¡ï¸ Run Nancy (Go vulnerability check)
        if: steps.check-go-module.outputs.skip-security-scan != 'true'
        working-directory: infra/aws/test/${{ matrix.test-dir }}
        run: |
          echo "ðŸ›¡ï¸ Running Nancy vulnerability check for ${{ matrix.test-dir }}..."
          if go list -json -deps ./... 2>/dev/null | nancy sleuth; then
            echo "âœ… Nancy scan completed successfully"
          else
            echo "âš ï¸ Nancy scan encountered issues but continuing..."
          fi
        continue-on-error: true

  terraform-version-check:
    name: ðŸ“‹ Terraform Version Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ” Check Terraform Version Consistency
        run: |
          echo "ðŸ” Checking Terraform version consistency across the project..."
          
          # Extract version from GitHub Actions workflow
          WORKFLOW_VERSION=$(grep -r "TF_VERSION:" .github/workflows/ | head -1 | cut -d'"' -f2)
          echo "Workflow version: $WORKFLOW_VERSION"
          
          # Check if .terraform-version file exists
          if [ -f ".terraform-version" ]; then
            FILE_VERSION=$(cat .terraform-version)
            echo "File version: $FILE_VERSION"
            
            if [ "$WORKFLOW_VERSION" != "$FILE_VERSION" ]; then
              echo "âŒ Terraform version mismatch!"
              echo "Workflow: $WORKFLOW_VERSION"
              echo "File: $FILE_VERSION"
              exit 1
            else
              echo "âœ… Terraform versions are consistent"
            fi
          else
            echo "âš ï¸ .terraform-version file not found - this is acceptable"
            echo "âœ… Using workflow version: $WORKFLOW_VERSION"
          fi

  terraform-docs-check:
    name: ðŸ“š Terraform Docs Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“š Generate Terraform Docs
        uses: terraform-docs/gh-actions@v1.2.0
        with:
          working-dir: infra/aws/modules/vpc,infra/aws/modules/alb,infra/aws/modules/ecs
          output-file: README.md
          output-method: inject
          git-push: false
          fail-on-diff: true

  cost-estimation:
    name: ðŸ’° Infrastructure Cost Estimation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: ðŸ”§ Terraform Init
        working-directory: infra/aws/env/dev
        run: |
          echo "ðŸš€ Initializing Terraform for cost estimation..."
          terraform init

      - name: ðŸ“‹ Generate Plan for Cost Estimation
        working-directory: infra/aws/env/dev
        run: |
          echo "ðŸ“‹ Generating Terraform plan for cost analysis..."
          terraform plan -out=tfplan.out
          terraform show -json tfplan.out > tfplan.json

      - name: ðŸ’° Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: ðŸ’° Generate Cost Estimate
        working-directory: infra/aws/env/dev
        run: |
          echo "ðŸ’° Generating infrastructure cost breakdown..."
          infracost breakdown --path=tfplan.json --format=json --out-file=infracost-base.json

      - name: ðŸ’¬ Comment Cost Estimate on PR
        uses: infracost/actions/comment@v1
        if: github.event_name == 'pull_request'
        with:
          path: infra/aws/env/dev/infracost-base.json
          behavior: update

  # ========================================
  # ðŸ“Š Dependency Summary
  # ========================================

  dependency-summary:
    name: ðŸ“Š Dependency Check Summary
    runs-on: ubuntu-latest
    needs: [go-security, terraform-version-check, terraform-docs-check]
    if: always()
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸ” Dependency Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Go Security Scan | ${{ needs.go-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“‹ Terraform Version Check | ${{ needs.terraform-version-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“š Terraform Docs Check | ${{ needs.terraform-docs-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.go-security.result }}" == "success" && "${{ needs.terraform-version-check.result }}" == "success" && "${{ needs.terraform-docs-check.result }}" == "success" ]]; then
            echo "âœ… All dependency checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some dependency checks failed. Please review above." >> $GITHUB_STEP_SUMMARY
          fi 
