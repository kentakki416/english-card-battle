name: â™»ï¸ Auto Merge
on: pull_request
permissions:
  contents: write
  pull-requests: write
defaults:
  run:
    shell: bash
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  # ========================================
  # dependabotãŒä½œæˆã™ã‚‹PRã®è‡ªå‹•ãƒãƒ¼ã‚¸
  # ãƒ‘ãƒƒãƒã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã€é–‹ç™ºä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€GitHub Actionsã®ãƒ‘ãƒƒãƒã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®å ´åˆã¯è‡ªå‹•ãƒãƒ¼ã‚¸
  # ========================================
  auto-merge:
    if: ${{ github.actor == 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ” Fetch Dependabot Metadata
        id: meta
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ env.GITHUB_TOKEN }}
          
      - name: ğŸ“‹ Log Update Information
        run: |
          echo "ğŸ” Update Type: ${{ steps.meta.outputs.update-type }}"
          echo "ğŸ“¦ Package Ecosystem: ${{ steps.meta.outputs.package-ecosystem }}"
          echo "ğŸ”— Dependency Type: ${{ steps.meta.outputs.dependency-type }}"
      
      # dependabotãŒä½œæˆã™ã‚‹PRã®ã†ã¡ã€ãƒ‘ãƒƒãƒã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã€é–‹ç™ºä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€GitHub Actionsã®ãƒ‘ãƒƒãƒã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®å ´åˆã¯è‡ªå‹•ãƒãƒ¼ã‚¸
      - name: âœ… Auto Merge
        if: >-
          ${{ steps.meta.outputs.update-type == 'version-update:semver-patch' ||
          (steps.meta.outputs.dependency-type == 'direct:development' && steps.meta.outputs.update-type != 'version-update:semver-major') ||
          (steps.meta.outputs.package-ecosystem == 'github_actions' && steps.meta.outputs.update-type != 'version-update:semver-major') }}
        run: |
          echo "ğŸš€ Starting auto merge process..."
          
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‰¿èª
          echo "âœ… Approving pull request..."
          gh pr review "${GITHUB_HEAD_REF}" --approve
          
          # è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’å®Ÿè¡Œ
          echo "ğŸ”„ Merging pull request..."
          gh pr merge "${GITHUB_HEAD_REF}" --merge --auto
          
          echo "ğŸ‰ Auto merge completed successfully!"
          
      - name: â­ï¸ Skip Major Updates
        if: >-
          ${{ steps.meta.outputs.update-type == 'version-update:semver-major'}}
        run: |
          echo "âš ï¸ Skipping major version update for security reasons"
          echo "ğŸ”— Please review manually: ${{ github.event.pull_request.html_url }}"
          
      - name: â­ï¸ Skip Other Updates
        if: >-
          ${{ steps.meta.outputs.update-type != 'version-update:semver-patch' &&
          !(steps.meta.outputs.dependency-type == 'direct:development' && steps.meta.outputs.update-type != 'version-update:semver-major') &&
          !(steps.meta.outputs.package-ecosystem == 'github_actions' && steps.meta.outputs.update-type != 'version-update:semver-major') }}
        run: |
          echo "â­ï¸ Skipping update - not eligible for auto merge"
          echo "ğŸ” Update Type: ${{ steps.meta.outputs.update-type }}"
          echo "ğŸ”— Please review manually: ${{ github.event.pull_request.html_url }}"
