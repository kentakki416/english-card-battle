name: ðŸš€ Terraform Apply

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prd
      confirm_apply:
        description: 'Type "APPLY" exactly to confirm deployment (case sensitive)'
        required: true
        type: string
      dry_run:
        description: 'Run plan only (dry run)'
        required: false
        default: false
        type: boolean

env:
  TF_VERSION: "1.7.0"
  TF_IN_AUTOMATION: true
  TF_INPUT: false
  AWS_REGION: ap-northeast-1

jobs:
  terraform-apply:
    name: ðŸš€ Terraform Apply
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment }}
      url: https://console.aws.amazon.com/
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      TF_VAR_environment: ${{ github.event.inputs.environment }}
    steps:
      - name: ðŸ” Validate Inputs
        run: |
          echo "ðŸ” Validating apply inputs..."
          
          # Normalize inputs
          CONFIRM_APPLY=$(echo "${{ github.event.inputs.confirm_apply }}" | tr -d '[:space:]')
          ENVIRONMENT=$(echo "${{ github.event.inputs.environment }}" | tr -d '[:space:]')
          
          # Check confirmation
          if [[ "${CONFIRM_APPLY}" != "APPLY" ]]; then
            echo "âŒ You must type 'APPLY' exactly to confirm"
            exit 1
          fi
          
          # Check environment validity
          if [[ "${ENVIRONMENT}" != "dev" && "${ENVIRONMENT}" != "prd" ]]; then
            echo "âŒ Invalid environment: ${ENVIRONMENT}"
            exit 1
          fi
          
          echo "âœ… Input validation passed"

      - name: ðŸ“¥ Checkout & Setup
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ðŸ”§ Terraform init
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸš€ Initializing Terraform for ${{ github.event.inputs.environment }}..."
          terraform init

      - name: ðŸ”§ Terraform plan
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ“‹ Generating apply plan..."
          terraform plan -detailed-exitcode -out=apply.tfplan

      - name: ðŸ” Terraform show
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "ðŸ“‹ Dry run - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ (${{ github.event.inputs.environment }}ç’°å¢ƒ)"
            echo "ðŸ’¡ å®Ÿéš›ã®å¤‰æ›´ã¯è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚ç¢ºèªå¾Œã€dry_run=falseã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
          else
            echo "ðŸš€ å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ - é©ç”¨äºˆå®šã®ãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ (${{ github.event.inputs.environment }}ç’°å¢ƒ)"
            echo "âš ï¸ ã“ã®å¾Œã€å®Ÿéš›ã«ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®å¤‰æ›´ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚"
          fi
          echo ""
          terraform show apply.tfplan

      - name: ðŸ” Safety Checks
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ” Running safety checks..."
          
          SAFETY_WARNINGS=0
          
          # ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤æ“ä½œã‚’ãƒã‚§ãƒƒã‚¯
          # ã‚±ãƒ¼ã‚¹ä¾‹: æ—¢å­˜ã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€RDSã€S3ãƒã‚±ãƒƒãƒˆãªã©ãŒå‰Šé™¤ã•ã‚Œã‚‹å ´åˆ
          # æ„å›³çš„ãªå‰Šé™¤ã®å ´åˆã‚‚ã‚ã‚‹ãŸã‚è­¦å‘Šã®ã¿è¡¨ç¤º
          PLAN_OUTPUT=$(terraform show apply.tfplan 2>/dev/null || echo "")
          if echo "$PLAN_OUTPUT" | grep -q "destroy" 2>/dev/null; then
            echo "âš ï¸ è­¦å‘Š: ãƒ—ãƒ©ãƒ³ã«ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤æ“ä½œãŒå«ã¾ã‚Œã¦ã„ã¾ã™"
            echo "å‰Šé™¤å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹:"
            echo "$PLAN_OUTPUT" | grep -A 2 -B 2 "destroy" || true
            echo "DESTROY_DETECTED=true" >> $GITHUB_ENV
            SAFETY_WARNINGS=$((SAFETY_WARNINGS + 1))
          fi
          
          # æ©Ÿå¯†æƒ…å ±ã®å¹³æ–‡éœ²å‡ºã‚’ãƒã‚§ãƒƒã‚¯  
          # ã‚±ãƒ¼ã‚¹ä¾‹: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€APIã‚­ãƒ¼ã€ç§˜å¯†éµãªã©ãŒå¹³æ–‡ã§è¡¨ç¤ºã•ã‚Œã‚‹å ´åˆ
          # Terraformã® sensitive = true ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§
          if echo "$PLAN_OUTPUT" | grep -i "password\|secret\|key" | grep -v "sensitive" >/dev/null 2>&1; then
            echo "âš ï¸ è­¦å‘Š: æ©Ÿå¯†æƒ…å ±ãŒå¹³æ–‡ã§éœ²å‡ºã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            echo "å¯¾è±¡ç®‡æ‰€:"
            echo "$PLAN_OUTPUT" | grep -i "password\|secret\|key" | grep -v "sensitive" || true
            echo "SENSITIVE_DETECTED=true" >> $GITHUB_ENV
            SAFETY_WARNINGS=$((SAFETY_WARNINGS + 1))
          fi
          
          # è­¦å‘ŠãŒã‚ã‚‹å ´åˆã¯Summaryã«è¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼ã«ã¯ã—ãªã„ï¼‰
          if [[ $SAFETY_WARNINGS -gt 0 ]]; then
            echo ""
            echo "âš ï¸ å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ã§ $SAFETY_WARNINGS ä»¶ã®è­¦å‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "è©³ç´°ã¯ä¸‹è¨˜ã®Summaryã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            echo "SAFETY_WARNINGS_COUNT=$SAFETY_WARNINGS" >> $GITHUB_ENV
          else
            echo "âœ… å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ã§å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: ðŸš€ Execute Apply
        if: github.event.inputs.dry_run != 'true'
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸš€ Applying infrastructure for ${{ github.event.inputs.environment }}..."
          echo "â° Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          terraform apply apply.tfplan
          
          echo "âœ… Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: ðŸ“Š Verify Results
        if: github.event.inputs.dry_run != 'true'
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ“Š Post-apply verification..."
          
          # Show outputs
          echo "=== Terraform Outputs ==="
          terraform output || echo "No outputs defined"
          
          # Show final state
          echo "=== Final State ==="
          RESOURCE_COUNT=$(terraform state list | wc -l)
          echo "ðŸ“Š Total resources managed: $RESOURCE_COUNT"
          echo "RESOURCE_COUNT=$RESOURCE_COUNT" >> $GITHUB_ENV

      - name: ðŸ“Š Plan Summary
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ“Š Extracting plan changes..."
          
          # terraform showã®å‡ºåŠ›ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦å‹•çš„ã«ãƒªã‚½ãƒ¼ã‚¹å¤‰æ›´ã‚’æŠ½å‡º
          PLAN_OUTPUT=$(terraform show apply.tfplan 2>/dev/null || echo "")
          
          # å„æ“ä½œã‚¿ã‚¤ãƒ—ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’æŠ½å‡º
          RESOURCES_TO_CREATE=$(echo "$PLAN_OUTPUT" | grep "^  # .* will be created$" | sed 's/^  # \(.*\) will be created$/\1/' || true)
          RESOURCES_TO_UPDATE=$(echo "$PLAN_OUTPUT" | grep "^  # .* will be updated in-place$" | sed 's/^  # \(.*\) will be updated in-place$/\1/' || true)
          RESOURCES_TO_DESTROY=$(echo "$PLAN_OUTPUT" | grep "^  # .* will be destroyed$" | sed 's/^  # \(.*\) will be destroyed$/\1/' || true)
          RESOURCES_TO_REPLACE=$(echo "$PLAN_OUTPUT" | grep "^  # .* must be replaced$" | sed 's/^  # \(.*\) must be replaced$/\1/' || true)
          
          # ã‚«ã‚¦ãƒ³ãƒˆ
          CREATE_COUNT=$(echo "$RESOURCES_TO_CREATE" | grep -c . || echo "0")
          UPDATE_COUNT=$(echo "$RESOURCES_TO_UPDATE" | grep -c . || echo "0")
          DESTROY_COUNT=$(echo "$RESOURCES_TO_DESTROY" | grep -c . || echo "0")
          REPLACE_COUNT=$(echo "$RESOURCES_TO_REPLACE" | grep -c . || echo "0")
          
          # ç’°å¢ƒå¤‰æ•°ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "CREATE_COUNT=$CREATE_COUNT" >> $GITHUB_ENV
          echo "UPDATE_COUNT=$UPDATE_COUNT" >> $GITHUB_ENV  
          echo "DESTROY_COUNT=$DESTROY_COUNT" >> $GITHUB_ENV
          echo "REPLACE_COUNT=$REPLACE_COUNT" >> $GITHUB_ENV
          
          echo "$RESOURCES_TO_CREATE" > /tmp/resources_create.txt
          echo "$RESOURCES_TO_UPDATE" > /tmp/resources_update.txt
          echo "$RESOURCES_TO_DESTROY" > /tmp/resources_destroy.txt
          echo "$RESOURCES_TO_REPLACE" > /tmp/resources_replace.txt
          
          echo "ðŸ“Š Plan analysis completed: +$CREATE_COUNT ~$UPDATE_COUNT -$DESTROY_COUNT â†»$REPLACE_COUNT"

      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸš€ Terraform Plan Summary (${{ github.event.inputs.environment }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ãƒ—ãƒ©ãƒ³å¤‰æ›´ã‚µãƒžãƒªãƒ¼
          echo "### ðŸ“‹ Plan Changes" >> $GITHUB_STEP_SUMMARY
          echo "| Operation | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âž• Create | ${{ env.CREATE_COUNT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Update | ${{ env.UPDATE_COUNT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—‘ï¸ Destroy | ${{ env.DESTROY_COUNT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Replace | ${{ env.REPLACE_COUNT }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹
          if [[ "${{ env.CREATE_COUNT }}" != "0" ]]; then
            echo "### âž• Resources to Create" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat /tmp/resources_create.txt 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY || echo "No resources to create" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ env.CREATE_COUNT }}" -gt 10 ]]; then
              echo "... and $(($(echo "${{ env.CREATE_COUNT }}" | sed 's/[^0-9]//g') - 10)) more" >> $GITHUB_STEP_SUMMARY
            fi
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ›´æ–°ã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹
          if [[ "${{ env.UPDATE_COUNT }}" != "0" ]]; then
            echo "### ðŸ”„ Resources to Update" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat /tmp/resources_update.txt 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY || echo "No resources to update" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ env.UPDATE_COUNT }}" -gt 10 ]]; then
              echo "... and $(($(echo "${{ env.UPDATE_COUNT }}" | sed 's/[^0-9]//g') - 10)) more" >> $GITHUB_STEP_SUMMARY
            fi
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # å‰Šé™¤ã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹
          if [[ "${{ env.DESTROY_COUNT }}" != "0" ]]; then
            echo "### ðŸ—‘ï¸ Resources to Destroy" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat /tmp/resources_destroy.txt 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY || echo "No resources to destroy" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ env.DESTROY_COUNT }}" -gt 10 ]]; then
              echo "... and $(($(echo "${{ env.DESTROY_COUNT }}" | sed 's/[^0-9]//g') - 10)) more" >> $GITHUB_STEP_SUMMARY
            fi
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ç½®æ›ã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹
          if [[ "${{ env.REPLACE_COUNT }}" != "0" ]]; then
            echo "### ðŸ” Resources to Replace" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat /tmp/resources_replace.txt 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY || echo "No resources to replace" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ env.REPLACE_COUNT }}" -gt 10 ]]; then
              echo "... and $(($(echo "${{ env.REPLACE_COUNT }}" | sed 's/[^0-9]//g') - 10)) more" >> $GITHUB_STEP_SUMMARY
            fi
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # å®Ÿè¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "### ðŸ“‹ Dry Run Completed" >> $GITHUB_STEP_SUMMARY
            echo "âœ… ãƒ—ãƒ©ãƒ³ãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å®Ÿè¡Œã™ã‚‹ã«ã¯ \`dry_run=false\` ã§å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Apply Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãŒæ­£å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          fi 
