name: ðŸš€ Terraform Apply

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prd
      confirm_apply:
        description: 'Type "APPLY" exactly to confirm deployment (case sensitive)'
        required: true
        type: string
      dry_run:
        description: 'Run plan only (dry run)'
        required: false
        default: false
        type: boolean

env:
  TF_VERSION: "1.7.0"
  TF_IN_AUTOMATION: true
  TF_INPUT: false
  AWS_REGION: ap-northeast-1

jobs:
  terraform-apply:
    name: ðŸš€ Terraform Apply
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment }}
      url: https://console.aws.amazon.com/
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      TF_VAR_environment: ${{ github.event.inputs.environment }}
    steps:
      - name: ðŸ” Validate Inputs
        run: |
          echo "ðŸ” Validating apply inputs..."
          
          # Normalize inputs
          CONFIRM_APPLY=$(echo "${{ github.event.inputs.confirm_apply }}" | tr -d '[:space:]')
          ENVIRONMENT=$(echo "${{ github.event.inputs.environment }}" | tr -d '[:space:]')
          
          # Check confirmation
          if [[ "${CONFIRM_APPLY}" != "APPLY" ]]; then
            echo "âŒ You must type 'APPLY' exactly to confirm"
            exit 1
          fi
          
          # Check environment validity
          if [[ "${ENVIRONMENT}" != "dev" && "${ENVIRONMENT}" != "prd" ]]; then
            echo "âŒ Invalid environment: ${ENVIRONMENT}"
            exit 1
          fi
          
          echo "âœ… Input validation passed"

      - name: ðŸ“¥ Checkout & Setup
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ðŸ”§ Initialize & Plan
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸš€ Initializing Terraform for ${{ github.event.inputs.environment }}..."
          terraform init
          
          echo "ðŸ“‹ Generating apply plan..."
          terraform plan -detailed-exitcode -out=apply.tfplan
          
          echo "ðŸ“Š Plan summary:"
          terraform show -no-color apply.tfplan

      - name: ðŸ” Safety Checks
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ” Running safety checks..."
          
          # Check for destroy operations
          if terraform show -no-color apply.tfplan | grep -q "destroy"; then
            echo "âš ï¸ WARNING: Plan contains resource destruction!"
            terraform show -no-color apply.tfplan | grep -A 2 -B 2 "destroy"
          fi
          
          # Check for sensitive data exposure
          if terraform show -no-color apply.tfplan | grep -i "password\|secret\|key" | grep -v "sensitive"; then
            echo "âš ï¸ WARNING: Potential sensitive data exposure!"
          fi
          
          echo "âœ… Safety checks completed"

      - name: ðŸš€ Execute Apply
        if: github.event.inputs.dry_run != 'true'
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸš€ Applying infrastructure for ${{ github.event.inputs.environment }}..."
          echo "â° Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          terraform apply apply.tfplan
          
          echo "âœ… Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: ðŸ“Š Verify Results
        if: github.event.inputs.dry_run != 'true'
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ“Š Post-apply verification..."
          
          # Show outputs
          echo "=== Terraform Outputs ==="
          terraform output || echo "No outputs defined"
          
          # Show final state
          echo "=== Final State ==="
          RESOURCE_COUNT=$(terraform state list | wc -l)
          echo "ðŸ“Š Total resources managed: $RESOURCE_COUNT"
          echo "RESOURCE_COUNT=$RESOURCE_COUNT" >> $GITHUB_ENV

      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸš€ Terraform Apply Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Environment | \`${{ github.event.inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Mode | \`${{ github.event.inputs.dry_run == 'true' && 'Dry Run' || 'Execute' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Resources | \`${{ env.RESOURCE_COUNT || 'N/A' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘¤ By | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ• Time | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "### ðŸ“‹ Dry run completed - plan generated" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ To execute, run again with dry_run=false" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Apply completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ Infrastructure has been deployed to ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "- Check AWS Console for deployed resources" >> $GITHUB_STEP_SUMMARY
            echo "- Verify application functionality" >> $GITHUB_STEP_SUMMARY
            echo "- Monitor CloudWatch for any issues" >> $GITHUB_STEP_SUMMARY
          fi 
