name: ðŸš€ Terraform Apply

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prd
      confirm_apply:
        description: 'Type "APPLY" exactly to confirm deployment (case sensitive)'
        required: true
        type: string
      dry_run:
        description: 'Run plan only (dry run)'
        required: false
        default: false
        type: boolean

env:
  TF_VERSION: "1.7.0"
  TF_IN_AUTOMATION: true
  TF_INPUT: false
  AWS_REGION: ap-northeast-1

jobs:
  terraform-apply:
    name: ðŸš€ Terraform Apply
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment }}
      url: https://console.aws.amazon.com/
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      TF_VAR_environment: ${{ github.event.inputs.environment }}
    steps:
      - name: ðŸ” Validate Inputs
        run: |
          echo "ðŸ” Validating apply inputs..."
          
          # Normalize inputs
          CONFIRM_APPLY=$(echo "${{ github.event.inputs.confirm_apply }}" | tr -d '[:space:]')
          ENVIRONMENT=$(echo "${{ github.event.inputs.environment }}" | tr -d '[:space:]')
          
          # Check confirmation
          if [[ "${CONFIRM_APPLY}" != "APPLY" ]]; then
            echo "âŒ You must type 'APPLY' exactly to confirm"
            exit 1
          fi
          
          # Check environment validity
          if [[ "${ENVIRONMENT}" != "dev" && "${ENVIRONMENT}" != "prd" ]]; then
            echo "âŒ Invalid environment: ${ENVIRONMENT}"
            exit 1
          fi
          
          echo "âœ… Input validation passed"

      - name: ðŸ“¥ Checkout & Setup
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ðŸ”§ Terraform init
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸš€ Initializing Terraform for ${{ github.event.inputs.environment }}..."
          terraform init

      - name: ðŸ”§ Terraform plan
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ“‹ Generating apply plan..."
          terraform plan -detailed-exitcode -out=apply.tfplan

      - name: ðŸ” Terraform show
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ“‹ Showing apply plan..."
          terraform show apply.tfplan

      - name: ðŸ” Safety Checks
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ” Running safety checks..."
          
          SAFETY_WARNINGS=0
          
          # ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤æ“ä½œã‚’ãƒã‚§ãƒƒã‚¯
          # ã‚±ãƒ¼ã‚¹ä¾‹: æ—¢å­˜ã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€RDSã€S3ãƒã‚±ãƒƒãƒˆãªã©ãŒå‰Šé™¤ã•ã‚Œã‚‹å ´åˆ
          # æ„å›³çš„ãªå‰Šé™¤ã®å ´åˆã‚‚ã‚ã‚‹ãŸã‚è­¦å‘Šã®ã¿è¡¨ç¤º
          if terraform show apply.tfplan | grep -q "destroy"; then
            echo "âš ï¸ è­¦å‘Š: ãƒ—ãƒ©ãƒ³ã«ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤æ“ä½œãŒå«ã¾ã‚Œã¦ã„ã¾ã™"
            echo "å‰Šé™¤å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹:"
            terraform show apply.tfplan | grep -A 2 -B 2 "destroy"
            echo "DESTROY_DETECTED=true" >> $GITHUB_ENV
            SAFETY_WARNINGS=$((SAFETY_WARNINGS + 1))
          fi
          
          # æ©Ÿå¯†æƒ…å ±ã®å¹³æ–‡éœ²å‡ºã‚’ãƒã‚§ãƒƒã‚¯  
          # ã‚±ãƒ¼ã‚¹ä¾‹: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€APIã‚­ãƒ¼ã€ç§˜å¯†éµãªã©ãŒå¹³æ–‡ã§è¡¨ç¤ºã•ã‚Œã‚‹å ´åˆ
          # Terraformã® sensitive = true ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§
          if terraform show apply.tfplan | grep -i "password\|secret\|key" | grep -v "sensitive"; then
            echo "âš ï¸ è­¦å‘Š: æ©Ÿå¯†æƒ…å ±ãŒå¹³æ–‡ã§éœ²å‡ºã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            echo "å¯¾è±¡ç®‡æ‰€:"
            terraform show apply.tfplan | grep -i "password\|secret\|key" | grep -v "sensitive"
            echo "SENSITIVE_DETECTED=true" >> $GITHUB_ENV
            SAFETY_WARNINGS=$((SAFETY_WARNINGS + 1))
          fi
          
          # è­¦å‘ŠãŒã‚ã‚‹å ´åˆã¯Summaryã«è¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼ã«ã¯ã—ãªã„ï¼‰
          if [[ $SAFETY_WARNINGS -gt 0 ]]; then
            echo ""
            echo "âš ï¸ å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ã§ $SAFETY_WARNINGS ä»¶ã®è­¦å‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "è©³ç´°ã¯ä¸‹è¨˜ã®Summaryã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            echo "SAFETY_WARNINGS_COUNT=$SAFETY_WARNINGS" >> $GITHUB_ENV
          else
            echo "âœ… å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ã§å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: ðŸš€ Execute Apply
        if: github.event.inputs.dry_run != 'true'
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸš€ Applying infrastructure for ${{ github.event.inputs.environment }}..."
          echo "â° Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          terraform apply apply.tfplan
          
          echo "âœ… Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: ðŸ“Š Verify Results
        if: github.event.inputs.dry_run != 'true'
        working-directory: infra/aws/env/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ“Š Post-apply verification..."
          
          # Show outputs
          echo "=== Terraform Outputs ==="
          terraform output || echo "No outputs defined"
          
          # Show final state
          echo "=== Final State ==="
          RESOURCE_COUNT=$(terraform state list | wc -l)
          echo "ðŸ“Š Total resources managed: $RESOURCE_COUNT"
          echo "RESOURCE_COUNT=$RESOURCE_COUNT" >> $GITHUB_ENV

      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸš€ Terraform Apply Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ã®è­¦å‘ŠãŒã‚ã‚‹å ´åˆã¯æœ€åˆã«è¡¨ç¤º
          if [[ "${{ env.SAFETY_WARNINGS_COUNT }}" != "" && "${{ env.SAFETY_WARNINGS_COUNT }}" != "0" ]]; then
            echo "### âš ï¸ å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯è­¦å‘Š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**${{ env.SAFETY_WARNINGS_COUNT }}ä»¶ã®è­¦å‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [[ "${{ env.DESTROY_DETECTED }}" == "true" ]]; then
              echo "ðŸ—‘ï¸ **ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤æ“ä½œ**: æ—¢å­˜ã®ãƒªã‚½ãƒ¼ã‚¹ãŒå‰Šé™¤ã•ã‚Œã¾ã™" >> $GITHUB_STEP_SUMMARY
              echo "   - æ„å›³çš„ãªå‰Šé™¤ã®å ´åˆã¯å•é¡Œã‚ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
              echo "   - äºˆæœŸã—ãªã„å‰Šé™¤ã®å ´åˆã¯è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [[ "${{ env.SENSITIVE_DETECTED }}" == "true" ]]; then
              echo "ðŸ” **æ©Ÿå¯†æƒ…å ±éœ²å‡º**: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„APIã‚­ãƒ¼ãŒå¹³æ–‡ã§è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
              echo "   - Terraformã§ \`sensitive = true\` ã‚’è¨­å®šã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
              echo "   - æ©Ÿå¯†æƒ…å ±ãŒãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Environment | \`${{ github.event.inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Mode | \`${{ github.event.inputs.dry_run == 'true' && 'Dry Run' || 'Execute' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Resources | \`${{ env.RESOURCE_COUNT || 'N/A' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| âš ï¸ Warnings | \`${{ env.SAFETY_WARNINGS_COUNT || '0' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘¤ By | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ• Time | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "### ðŸ“‹ Dry run completed - plan generated" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ env.SAFETY_WARNINGS_COUNT }}" != "" && "${{ env.SAFETY_WARNINGS_COUNT }}" != "0" ]]; then
              echo "âš ï¸ **è­¦å‘Šã‚’ç¢ºèªã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„** - dry_run=falseã§å†å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… å•é¡Œãªã— - dry_run=falseã§å®Ÿè¡Œå¯èƒ½ã§ã™" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âœ… Apply completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ Infrastructure has been deployed to ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "- Check AWS Console for deployed resources" >> $GITHUB_STEP_SUMMARY
            echo "- Verify application functionality" >> $GITHUB_STEP_SUMMARY
            echo "- Monitor CloudWatch for any issues" >> $GITHUB_STEP_SUMMARY
          fi 
