name: ğŸ—ï¸ Terraform CI Pipeline
on:
  push:
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/terraform-test.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prd
permissions:
  contents: read
  pull-requests: write
  security-events: write
defaults:
  run:
    shell: bash
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
env:
  TF_VERSION: "1.7.0"
  TF_IN_AUTOMATION: true
  TF_INPUT: false
  AWS_REGION: ap-northeast-1
jobs:
  # ========================================
  # ğŸ” Change Detection
  # ========================================
  
  changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      terraform: ${{ steps.changes.outputs.terraform }}
      tests: ${{ steps.changes.outputs.tests }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Detect Changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            terraform:
              - 'infra/**/*.tf'
              - 'infra/**/*.tfvars'
              - 'infra/**/*.tfvars.example'
            tests:
              - 'infra/**/*test.go'
              - 'infra/**/go.mod'
              - 'infra/**/go.sum'

  # ========================================
  # ğŸ§¹ Lint & Security
  # ========================================

  lint-and-security:
    name: ğŸ§¹ Lint & Security
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: changes
    if: needs.changes.outputs.terraform == 'true'
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ğŸ¯ Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: ğŸ“ Format Check
        working-directory: infra/aws
        run: terraform fmt -check -recursive -diff

      - name: âœ… Validate & Lint
        working-directory: infra/aws/env/dev
        run: |
          terraform init -backend=false
          terraform validate
          cd ../../
          tflint --init
          tflint --format compact

      - name: ğŸ”’ Security Scan
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: infra/aws
          soft_fail: true

      - name: ğŸ›¡ï¸ Checkov Scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infra/aws
          soft_fail: true
          framework: terraform
          output_format: sarif
          output_file_path: checkov-results.sarif

  # ========================================
  # ğŸ§ª Go Tests
  # ========================================

  go-tests:
    name: ğŸ§ª Go Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: changes
    if: needs.changes.outputs.tests == 'true' || needs.changes.outputs.terraform == 'true'
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ap-northeast-1
      TERRATEST_TERRAFORM_BINARY: terraform
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: infra/aws/test/go.sum

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ğŸ§ª Run Tests
        working-directory: infra/aws/test
        env:
          TERRATEST_PLAN_ONLY: "true"
        run: |
          go mod download
          go test -v ./unit/... -timeout 30m
          
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            # TODO: ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§test skip
            # go test -v ./integration/... -timeout 45m
          fi

  # ========================================
  # ğŸ“‹ Terraform Plan (Multi-Environment)
  # ========================================

  terraform-plan:
    name: ğŸ“‹ Terraform Plan (${{ matrix.environment }})
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: changes
    if: needs.changes.outputs.terraform == 'true'
    strategy:
      fail-fast: false
      matrix:
        environment: [dev, prd]
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    outputs:
      plan_output_dev: ${{ steps.format_plan.outputs.plan_output_dev }}
      plan_output_prd: ${{ steps.format_plan.outputs.plan_output_prd }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: ğŸ”§ Terraform init
        working-directory: infra/aws/env/${{ matrix.environment }}
        run: terraform init

      - name: ğŸ“‹ Generate Plan
        working-directory: infra/aws/env/${{ matrix.environment }}
        run: |
          terraform plan -detailed-exitcode -out=tfplan.out | tee plan_output.txt
        continue-on-error: true

      - name: ğŸ” Safety Checks
        working-directory: infra/aws/env/${{ matrix.environment }}
        run: |
          if [ -f tfplan.out ]; then
            if terraform show tfplan.out | grep -q "destroy"; then
              echo "âš ï¸ WARNING: Plan contains resource destruction in ${{ matrix.environment }}!"
              echo "::warning title=Resource Destruction::Plan for ${{ matrix.environment }} contains resource destruction"
            fi
            
            # ãƒªã‚½ãƒ¼ã‚¹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            RESOURCES_TO_ADD=$(terraform show tfplan.out | grep -c "# .* will be created" || echo "0")
            RESOURCES_TO_CHANGE=$(terraform show tfplan.out | grep -c "# .* will be updated" || echo "0") 
            RESOURCES_TO_DESTROY=$(terraform show tfplan.out | grep -c "# .* will be destroyed" || echo "0")
            
            echo "ğŸ“Š Plan Summary for ${{ matrix.environment }}:"
            echo "  âœ… To Add: $RESOURCES_TO_ADD"
            echo "  ğŸ”„ To Change: $RESOURCES_TO_CHANGE"
            echo "  ğŸ—‘ï¸ To Destroy: $RESOURCES_TO_DESTROY"
            
            # GitHub Summary ã«è¿½åŠ 
            echo "### ğŸ“Š ${{ matrix.environment }} Plan Summary" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Resources to Add: **$RESOURCES_TO_ADD**" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”„ Resources to Change: **$RESOURCES_TO_CHANGE**" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ—‘ï¸ Resources to Destroy: **$RESOURCES_TO_DESTROY**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“ Format Plan for PR
        id: format_plan
        if: github.event_name == 'pull_request'
        working-directory: infra/aws/env/${{ matrix.environment }}
        run: |
          if [ -f plan_output.txt ]; then
            PLAN_OUTPUT=$(cat plan_output.txt)
            
            # å‡ºåŠ›ã‚µã‚¤ã‚ºåˆ¶é™
            if [ ${#PLAN_OUTPUT} -gt 8000 ]; then
              PLAN_OUTPUT="${PLAN_OUTPUT:0:8000}... (truncated)"
            fi
            
            # ç’°å¢ƒåˆ¥ã®å‡ºåŠ›ã¨ã—ã¦ä¿å­˜
            {
              echo "plan_output_${{ matrix.environment }}<<EOF"
              echo "$PLAN_OUTPUT"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi

  # ========================================
  # ğŸ’° Cost Estimation (Optional)
  # ========================================

  cost-estimation:
    name: ğŸ’° Cost Estimation (${{ matrix.environment }})
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: terraform-plan
    if: github.event_name == 'pull_request' && needs.changes.outputs.terraform == 'true' && vars.ENABLE_COST_ESTIMATION == 'true'
    strategy:
      fail-fast: false
      matrix:
        environment: [dev, prd]
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ matrix.environment }}
          path: infra/aws/env/${{ matrix.environment }}

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ğŸ“‹ Convert Plan to JSON
        working-directory: infra/aws/env/${{ matrix.environment }}
        run: |
          terraform init
          terraform show -json tfplan.out > tfplan.json

      - name: ğŸ’° Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: ğŸ’° Generate Cost Estimate
        working-directory: infra/aws/env/${{ matrix.environment }}
        run: infracost breakdown --path=tfplan.json --format=json --out-file=infracost-${{ matrix.environment }}.json

      - name: ğŸ’¬ Comment Cost on PR
        uses: infracost/actions/comment@v3
        with:
          path: infra/aws/env/${{ matrix.environment }}/infracost-${{ matrix.environment }}.json
          behavior: update

  # ========================================
  # ğŸ’¬ PR Summary
  # ========================================

  pr-summary:
    name: ğŸ’¬ PR Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [changes, lint-and-security, go-tests, terraform-plan, cost-estimation]
    if: github.event_name == 'pull_request' && always()
    steps:
      - name: ğŸ” Find Previous Comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '## ğŸ—ï¸ Terraform CI Results'

      - name: ğŸ’¬ Create or Update Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## ğŸ—ï¸ Terraform CI Results
            
            | Check | Status |
            |-------|--------|
            | ğŸ§¹ Lint & Security | ${{ needs.lint-and-security.result }} |
            | ğŸ§ª Go Tests | ${{ needs.go-tests.result }} |
            | ğŸ“‹ Terraform Plan (dev) | ${{ needs.terraform-plan.result }} |
            | ğŸ“‹ Terraform Plan (prd) | ${{ needs.terraform-plan.result }} |
            | ğŸ’° Cost Estimation | ${{ needs.cost-estimation.result || 'â­ï¸ Skipped' }} |
            
            ### ğŸ” Changes Detected
            - **Terraform**: `${{ needs.changes.outputs.terraform }}`
            - **Tests**: `${{ needs.changes.outputs.tests }}`
            
            ### ğŸ“‹ Terraform Plans
            
            #### ğŸ› ï¸ Development Environment
            <details>
            <summary>Show Dev Plan Output</summary>
            
            ```hcl
            ${{ needs.terraform-plan.outputs.plan_output_dev || 'Dev plan output not available' }}
            ```
            </details>
            
            #### ğŸ­ Production Environment  
            <details>
            <summary>Show Prd Plan Output</summary>
            
            ```hcl
            ${{ needs.terraform-plan.outputs.plan_output_prd || 'Prd plan output not available' }}
            ```
            </details>
            
            ### âœ… Status
            ${{ (needs.lint-and-security.result == 'success' && needs.terraform-plan.result == 'success') && 'ğŸ‰ Ready for merge!' || 'âŒ Please fix issues above.' }}
            
            ---
            *Updated: ${{ github.event.pull_request.updated_at }}*
